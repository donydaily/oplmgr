#!/usr/bin/env sh
# oplmgr - PS2 OPL USB/HDD Manager (CLI)
# v1.3.1 POSIX FINAL (portable sh)

set -eu

APP_NAME="oplmgr"
VERSION="1.3.1"

# -------- utils --------
err(){ echo "[!] $*" >&2; exit 1; }
info(){ echo "[*] $*"; }
ok(){ echo "[+] $*"; }
need(){ command -v "$1" >/dev/null 2>&1 || err "dependency missing: $1"; }

# deps
for b in lsblk awk sed grep stat split pv du sort cat find curl 7z; do
  need "$b"
done

# -------- helpers --------
usage(){
cat <<EOF
$APP_NAME v$VERSION

Usage:
  $APP_NAME scan
  $APP_NAME inject <game.iso> <PS2_MOUNT>
  $APP_NAME list <PS2_MOUNT>
  $APP_NAME remove <GAME_ID> <PS2_MOUNT>
  $APP_NAME extract <GAME_ID> <OUTPUT_DIR>
  $APP_NAME verify <PS2_MOUNT>
  $APP_NAME rename <GAME_ID> <NEW_TITLE> <PS2_MOUNT>
  $APP_NAME rebuild-ulcfg <PS2_MOUNT>
  $APP_NAME art <PS2_MOUNT>
EOF
}

sanitize(){ echo "$1" | sed 's/[^A-Za-z0-9._ -]/_/g'; }

is_dvd(){
  size=$(stat -c%s "$1")
  [ "$size" -gt 734003200 ]
}

get_game_id(){
  iso="$1"
  id=$(7z x -so "$iso" SYSTEM.CNF 2>/dev/null | grep -Eo '(SLUS|SLES|SCUS|SCES)_[0-9]{3}\.[0-9]{2}' | head -n 1 || true)
  [ -n "$id" ] && echo "$id" || echo "UNKNOWN_000.00"
}

ensure_dirs(){ mkdir -p "$1/DVD" "$1/CD" "$1/ART"; }

update_ulcfg(){
  mnt="$1"; id="$2"; title="$3"; type="$4"
  cfg="$mnt/ul.cfg"
  [ -f "$cfg" ] && grep -v "^$id|" "$cfg" > "$cfg.tmp" || : > "$cfg.tmp"
  echo "$id|$title|$type" >> "$cfg.tmp"
  mv "$cfg.tmp" "$cfg"
}

# -------- commands --------
cmd_scan(){
  info "Scanning removable drives"
  lsblk -o NAME,SIZE,FSTYPE,LABEL,MOUNTPOINT,RM | awk 'NR==1 || $6==1'
}

cmd_inject(){
  [ "$#" -eq 2 ] || usage
  iso="$1"; mnt="$2"
  [ -f "$iso" ] || err "ISO not found"
  [ -d "$mnt" ] || err "Mount not found"

  ensure_dirs "$mnt"

  id=$(get_game_id "$iso")
  title=$(sanitize "$(basename "$iso" .iso)")

  if is_dvd "$iso"; then type="DVD"; dest="$mnt/DVD"; else type="CD"; dest="$mnt/CD"; fi

  base="$id.$title.iso"
  info "Injecting $base ($type)"

  pv "$iso" | split -b 1G -d -a 2 - "$dest/$base."

  update_ulcfg "$mnt" "$id" "$title" "$type"
  ok "Injected & ul.cfg updated"
}

cmd_list(){
  [ "$#" -eq 1 ] || err "list <PS2_MOUNT>"
  mnt="$1"
  printf "%-5s %-15s %-8s %s\n" "TYPE" "GAME ID" "SIZE" "TITLE"
  printf "%s\n" "-----------------------------------------------------"

  for d in DVD CD; do
    [ -d "$mnt/$d" ] || continue
    for f in "$mnt/$d"/*.iso.00; do
      [ -e "$f" ] || continue
      base=${f%.iso.00}
      name=$(basename "$base")
      id=$(echo "$name" | cut -d. -f1)
      title=$(echo "$name" | cut -d. -f2-)
      size=$(du -ch "$mnt/$d"/$id.* | tail -n 1 | awk '{print $1}')
      printf "%-5s %-15s %-8s %s\n" "$d" "$id" "$size" "$title"
    done
  done | sort -u
}

cmd_remove(){
  [ "$#" -eq 2 ] || err "remove <GAME_ID> <PS2_MOUNT>"
  id="$1"; mnt="$2"
  files=$(find "$mnt" -type f -name "$id*.iso.*" 2>/dev/null || true)
  [ -n "$files" ] || err "Game not found"
  echo "$files"
  printf "Delete game %s ? [y/N]: " "$id"
  read ans || true
  case "$ans" in y|Y) ;; *) err "Canceled";; esac
  rm -f $files
  [ -f "$mnt/ul.cfg" ] && grep -v "^$id|" "$mnt/ul.cfg" > "$mnt/ul.cfg.tmp" || : > "$mnt/ul.cfg.tmp"
  mv "$mnt/ul.cfg.tmp" "$mnt/ul.cfg" 2>/dev/null || true
  ok "Removed"
}

cmd_extract(){
  [ "$#" -eq 2 ] || err "extract <GAME_ID> <OUT_DIR>"
  id="$1"; out="$2"
  mkdir -p "$out"
  parts=$(find . -type f -name "$id*.iso.*" | sort)
  [ -n "$parts" ] || err "Parts not found"
  info "Extracting $id"
  cat $parts | pv > "$out/$id.iso"
  ok "Extracted to $out/$id.iso"
}

cmd_verify(){
  [ "$#" -eq 1 ] || err "verify <PS2_MOUNT>"
  mnt="$1"
  for d in DVD CD; do
    [ -d "$mnt/$d" ] || continue
    info "Checking $d"
    for f in "$mnt/$d"/*.iso.00; do
      [ -e "$f" ] || continue
      base=${f%.iso.00}
      i=0; okf=1
      while :; do
        p=$(printf "%s.iso.%02d" "$base" "$i")
        [ -f "$p" ] || break
        i=$((i+1))
      done
      [ "$i" -eq 0 ] && okf=0
      if [ "$okf" -eq 1 ]; then
        echo "[OK] $(basename "$base")"
      else
        echo "[BROKEN] $(basename "$base")"
      fi
    done
  done
}

cmd_rename(){
  [ "$#" -eq 3 ] || err "rename <GAME_ID> <NEW_TITLE> <PS2_MOUNT>"
  id="$1"; new=$(sanitize "$2"); mnt="$3"
  for d in DVD CD; do
    for f in "$mnt/$d"/$id.*.iso.*; do
      [ -e "$f" ] || continue
      suf=${f#*$id.}
      mv "$f" "$mnt/$d/$id.$new.${suf#*.}"
    done
  done
  [ -f "$mnt/ul.cfg" ] && sed -i "s|^$id|$id|$new|" "$mnt/ul.cfg" 2>/dev/null || true
  ok "Renamed"
}

cmd_rebuild_ulcfg(){
  [ "$#" -eq 1 ] || err "rebuild-ulcfg <PS2_MOUNT>"
  mnt="$1"
  : > "$mnt/ul.cfg"
  for d in DVD CD; do
    for f in "$mnt/$d"/*.iso.00; do
      [ -e "$f" ] || continue
      base=${f%.iso.00}
      name=$(basename "$base")
      id=$(echo "$name" | cut -d. -f1)
      title=$(echo "$name" | cut -d. -f2-)
      update_ulcfg "$mnt" "$id" "$title" "$d"
    done
  done
  ok "ul.cfg rebuilt"
}

cmd_art(){
  [ "$#" -eq 1 ] || err "art <PS2_MOUNT>"
  mnt="$1"
  ensure_dirs "$mnt"
  ART_BASE_URL="https://raw.githubusercontent.com/xlenore/ps2-covers/main"
  [ -f "$mnt/ul.cfg" ] || err "ul.cfg not found"
  info "Downloading ART covers"
  cut -d'|' -f1 "$mnt/ul.cfg" | while read id; do
    [ -z "$id" ] && continue
    out="$mnt/ART/$id.png"
    [ -f "$out" ] && continue
    url="$ART_BASE_URL/$id.png"
    info "Fetching $id"
    curl -fsSL "$url" -o "$out" || echo "[WARN] Cover not found for $id"
  done
  ok "ART download finished"
}

# -------- main --------
case "${1:-}" in
  scan) shift; cmd_scan "$@";;
  inject) shift; cmd_inject "$@";;
  list) shift; cmd_list "$@";;
  remove) shift; cmd_remove "$@";;
  extract) shift; cmd_extract "$@";;
  verify) shift; cmd_verify "$@";;
  rename) shift; cmd_rename "$@";;
  rebuild-ulcfg) shift; cmd_rebuild_ulcfg "$@";;
  art) shift; cmd_art "$@";;
  -h|--help|"") usage;;
  *) err "Unknown command: $1";;
esac
